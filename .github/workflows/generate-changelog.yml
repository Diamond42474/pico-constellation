name: Generate CHANGELOG and open PR

on:
  push:
    branches: [ main ]

jobs:
  generate-changelog:
    name: Generate CHANGELOG
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install conventional-changelog CLI
        run: npm install -g conventional-changelog-cli@4 || true

      - name: Generate CHANGELOG.md
        run: |
          # Ensure we have a changelog file to update
          if [ ! -f CHANGELOG.md ]; then
            echo "# Changelog" > CHANGELOG.md
            echo >> CHANGELOG.md
          fi

          # Try using the conventionalcommits preset first (matches Conventional Commits spec).
          # Fall back to angular preset if unavailable.
          set -o pipefail
          conventional-changelog -p conventionalcommits -i CHANGELOG.md -s -r 0 || conventional-changelog -p angular -i CHANGELOG.md -s -r 0 || true

      - name: Show diff (for debugging)
        run: git --no-pager diff --name-only || true

      - name: Create pull request with updated CHANGELOG
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: generate CHANGELOG.md"
          branch: chore/update-changelog-${{ github.run_id }}
          title: "chore: Update CHANGELOG.md"
          body: |
            "This PR was generated automatically by GitHub Actions and updates the CHANGELOG.md with changes since the last release tag based on Conventional Commits."
          labels: automated-changelog, ci
          add-paths: CHANGELOG.md